'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[40],{1352:function(w,D,a){function b(Z){for(const aa of Z.values())for(const Ea of aa.annotations)if(!Ea.isInternal&&!Ea.Yt)return!0;return!1}function c(Z){return void 0===Z?"undefined":`${null===Z||void 0===Z?void 0:Z.Xluid}/${null===Z||void 0===Z?void 0:Z.Xrevid}@${null===Z||void 0===Z?void 0:Z.DocId}`}a.r(D);w={};a.r(w);a.d(w,"AugmentationLoopServerStatus",function(){return Jb});a.d(w,"AugmentationLoopManager",
function(){return ub});var e=a(0),f=a(2),d=a(15),h=a(105);D=a(234);var r=a(733);class n{}Object(e.a)(n,"WorkbookCoauthVersion",null,[]);var u=a(39);class v{constructor(){this.stateId=0;this.Zae=null}}Object(e.a)(v,"StateIdChangedInfo",null,[]);var x=a(65);const k=(Z,aa,Ea,za,bb,Mb,zb)=>{zb=Z.Ra(1,void 0===zb?null:zb);zb.isObserverRequired=aa;return x.g(Z,"ObserverRequiredNotification",zb,Ea,za,bb,Mb,0)};class m extends Sys.EventArgs{constructor(Z,aa,Ea,za){super();this.annotation=Z;this.parentObject=
aa;this.parentPath=Ea;this.operationType=za}}Object(e.a)(m,"AnnotationEventArgs",Sys.EventArgs,[]);var t=a(34),z=a(135),y=a(1);class C{constructor(){this.stateUpdateHandler=this.handler=this.config=this.annotationType=null}}Object(e.a)(C,"ActivateAnnotationParameters",null,[]);class J{constructor(){this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.userListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.metadataVersion=this.ecsOperationUrl=
this.ecsRestUrl=this.ecsSessionId=this.wacCluster=null}}Object(e.a)(J,"ExcelServerParameters",null,[]);class F{constructor(){this.excelServerParameters=null}}Object(e.a)(F,"ForceReconnectParameters",null,[]);class K{constructor(){this.workflow=null}}Object(e.a)(K,"RegisterLocalWorkflowParameters",null,[]);class L{constructor(){this.handler=null}}Object(e.a)(L,"SetAnnotationResultCallbackParameters",null,[]);class S{constructor(){this.message=null}}Object(e.a)(S,"SubmitCustomMessageParameters",null,
[]);class W{constructor(){this.operation=null}}Object(e.a)(W,"SubmitOperationParameters",null,[]);var G=a(766),O=a(1035),T=a(794),I=a(739);class N extends T.a{constructor(){super();this.isTriggeredBySyncDelta=null;this.H_=Object.assign(new I.a,{T_:N.getTypeName(),B_:N.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}Object(e.a)(N,"DeleteOperation",T.a,[]);class R extends T.a{constructor(){super();this.isFocused=!1;this.H_=
Object.assign(new I.a,{T_:R.getTypeName(),B_:R.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_FocusOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}Object(e.a)(R,"FocusOperation",T.a,[]);var V=a(928),sa=a(1036);class U extends sa.a{constructor(){super();this.prevParentPath=null;this.H_=Object.assign(new I.a,{T_:U.getTypeName(),B_:U.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_MoveOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext",
"AugLoop_Core_Operation"]}}Object(e.a)(U,"MoveOperation",sa.a,[]);var ka=a(1034);class ja extends T.a{constructor(){super();this.M_=null;this.H_=Object.assign(new I.a,{T_:ja.getTypeName(),B_:ja.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}Object(e.a)(ja,"UpdateAnnotationMetaDataOperation",T.a,[]);var Da=a(1037);class qa extends T.a{constructor(){super();this.isVisible=!1;this.H_=Object.assign(new I.a,
{T_:qa.getTypeName(),B_:qa.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}Object(e.a)(qa,"VisibilityOperation",T.a,[]);var Ba=a(758);class ua extends Ba.a{constructor(){super();this.bridgeId=this.cv=this.messageId=null;this.H_=Object.assign(new I.a,{T_:ua.getTypeName(),B_:ua.getBaseTypes()})}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static getBaseTypes(){return[]}}Object(e.a)(ua,"Message",Ba.a,
[]);class pa extends ua{constructor(){super();this.activeWorksheetId=null;this.H_=Object.assign(new I.a,{T_:pa.getTypeName(),B_:pa.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelKeepAlive"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}}Object(e.a)(pa,"ExcelKeepAlive",ua,[]);class Ka extends G.a{constructor(){super();this.isObserverRequired=this.isSeedingRequired=!1;this.H_=Object.assign(new I.a,{T_:Ka.getTypeName(),B_:Ka.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}}
Object(e.a)(Ka,"ObserverStatusAnnotation",G.a,[]);class $a extends ua{constructor(){super();this.parentPath=this.opType=this.seq=this.item=null;this.H_=Object.assign(new I.a,{T_:$a.getTypeName(),B_:$a.getBaseTypes()})}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}}Object(e.a)($a,"MicroSyncMessage",ua,[]);class ha extends Ba.a{constructor(){super();this.id=null;this.sizeBytes=0;this.dataPointer=this.data=null;
this.H_=Object.assign(new I.a,{T_:ha.getTypeName(),B_:ha.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_Blob"}static getBaseTypes(){return[]}}Object(e.a)(ha,"Blob",Ba.a,[]);class cb extends ha{constructor(){super();this.format=0;this.otherFormat=null;this.size=0;this.isOriginalSize=null;this.H_=Object.assign(new I.a,{T_:cb.getTypeName(),B_:cb.getBaseTypes()})}static getTypeName(){return"AugLoop_Image_ImageContent"}static getBaseTypes(){return["AugLoop_Core_Blob"]}}Object(e.a)(cb,"ImageContent",
ha,[]);class Ia extends Ba.a{constructor(){super();this.heightPx=this.widthPx=0;this.H_=Object.assign(new I.a,{T_:Ia.getTypeName(),B_:Ia.getBaseTypes()})}static getTypeName(){return"AugLoop_Image_ImageTileMetadata"}static getBaseTypes(){return[]}}Object(e.a)(Ia,"ImageTileMetadata",Ba.a,[]);class ob extends Ia{constructor(){super();this.contents=null;this.H_=Object.assign(new I.a,{T_:ob.getTypeName(),B_:ob.getBaseTypes()})}static getTypeName(){return"AugLoop_Image_ImageTile"}static getBaseTypes(){return["AugLoop_Image_ImageTileMetadata"]}}
Object(e.a)(ob,"ImageTile",Ia,[]);var gb=a(108),Za;(function(Z){Z[Z.unknown=0]="unknown";Z[Z.fatal=1]="fatal";Z[Z.tokenExpired=2]="tokenExpired";Z[Z.modelWorkflowNotSupported=3]="modelWorkflowNotSupported"})(Za||(Za={}));Object(e.b)("ExcelSessionErrorType",Za);class da{constructor(){this.annotations=[]}RZ(Z){this.tM=Z;return this}activateAnnotation(Z){if(this.annotations.includes(Z))throw Z=`Annotation from type ${Z.annotationType} was already activated`,d.ULS.sendTraceTag(521216417,0,10,`AugmentationLoopFeatureRegistrationInfoBuilder.activateAnnotation: ${Z}`),
Error(Z);this.annotations.push(Z);return this}TZ(Z){this.featureName=Z;return this}build(){if(void 0===this.tM)throw d.ULS.sendTraceTag(521216416,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Close callback is not set"),Error("Close callback is not set");if(!this.featureName)throw d.ULS.sendTraceTag(521216414,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Feature Name is not set"),Error("Feature Name is not set");return{featureName:this.featureName,tM:this.tM,annotations:this.annotations}}}
Object(e.a)(da,"AugmentationLoopFeatureRegistrationInfoBuilder",null,[729]);var ya=a(74),ib=a(19),vb;(function(Z){Z.newAnnotation="New";Z.validAnnotation="Valid";Z.invalidAnnotation="Invalid"})(vb||(vb={}));Object(e.b)("AnnotationCallbackType",vb);var eb;(function(Z){Z.newAnnotation="New";Z.validOnArrivalAnnotation="ValidOnArrival";Z.validAfterSomeTimeAnnotation="ValidAfterSomeTime";Z.invalidOnCoauthVersionChangedAnnotation="InvalidOnCoauthVersionChanged";Z.invalidAfterTimeoutAnnotation="InvalidAfterTimeout"})(eb||
(eb={}));Object(e.b)("AnnotationEventType",eb);var Ta;(function(Z){Z[Z.beforeAnnotation=0]="beforeAnnotation";Z[Z.atAnnotation=1]="atAnnotation";Z[Z.afterAnnotation=2]="afterAnnotation"})(Ta||(Ta={}));Object(e.b)("TimelinePosition",Ta);class La{constructor(){this.Dkb=new Map;d.ULS.sendTraceTag(520176320,0,50,"AugmentationLoopAnnotationValidatorLogger.constructor: called")}Xze(Z){this.Dkb.has(Z)||(d.ULS.sendTraceTag(520176291,0,50,`AugmentationLoopAnnotationValidatorLogger.addAnnotationType: ${Z}`),
this.Dkb.set(Z,[]))}pzj(Z){this.Dkb.delete(Z)&&d.ULS.sendTraceTag(520176290,0,50,`AugmentationLoopAnnotationValidatorLogger.removeAnnotationType: ${Z}`)}hcj(Z,aa){Z.find(Ea=>Ea.annotationId===aa)||Z.push({annotationId:aa,Z$j:Date.now(),v8b:eb.newAnnotation})}GTi(Z,aa,Ea,za){d.ULS.sendTraceTag(520176289,0,50,`AugmentationLoopAnnotationValidatorLogger.logLatencyEntry: type: ${Z}, entry: (${aa.annotationId} ${aa.v8b}) incoming: ${za}, latency: ${Ea-aa.Z$j} ms`)}wri(Z,aa,Ea){return(Ea===eb.validAfterSomeTimeAnnotation||
Ea===eb.validOnArrivalAnnotation)&&(Z.annotationId===aa||Z.v8b===eb.invalidAfterTimeoutAnnotation)}Wgj(Z,aa,Ea,za){let bb=[];const Mb=Date.now();let zb=Ta.beforeAnnotation;for(let oa of aa){this.wri(oa,Ea,za)&&this.GTi(Z,oa,Mb,za);if(oa.annotationId===Ea){oa.v8b=za;if(za===eb.invalidAfterTimeoutAnnotation)return;zb=Ta.atAnnotation}else zb===Ta.atAnnotation&&(zb=Ta.afterAnnotation);aa=za===eb.invalidOnCoauthVersionChangedAnnotation?oa.annotationId!==Ea:oa.v8b===eb.newAnnotation;const Xa=zb===Ta.afterAnnotation;
(zb!==Ta.afterAnnotation&&aa||Xa)&&bb.push(oa)}this.Dkb.set(Z,bb)}e4i(Z,aa,Ea){let za=this.Dkb.get(Z);za||(this.Xze(Z),za=this.Dkb.get(Z));Ea===eb.newAnnotation?this.hcj(za,aa):this.Wgj(Z,za,aa,Ea)}}Object(e.a)(La,"AugmentationLoopAnnotationValidatorLogger",null,[]);class fb{constructor(Z,aa){this.toString=()=>JSON.stringify(this);this.annotationId=Z;this.coauthVersion=aa}}Object(e.a)(fb,"LocalAnnotationId",null,[]);class Pb extends u.a{constructor(Z){Z=void 0===Z?36E5:Z;super();this.z9=new Map;this.X2=
new Map;this.OTa=new Set;this.qbe=new La;this.n6e=Z;d.ULS.sendTraceTag(523337872,0,50,`AugmentationLoopAnnotationValidator.constructor: annotationExpirationTimeout: ${this.n6e} ms`)}dispose(){d.ULS.sendTraceTag(523337871,0,50,`AugmentationLoopAnnotationValidator.dispose: ${this.getStatus()}`);this.OTa.clear();this.X2.clear();this.z9.clear();super.dispose()}Wze(Z,aa,Ea){d.ULS.sendTraceTag(521405908,0,50,`AugmentationLoopAnnotationValidator.addAnnotationCallback: annotationType: ${aa}`);this.addHandler(this.vId(Z,
aa),Ea);this.qbe.Xze(aa)}W5f(Z,aa,Ea){d.ULS.sendTraceTag(521405907,0,50,`AugmentationLoopAnnotationValidator.removeAnnotationCallback: annotationType: ${aa}`);this.removeHandler(this.vId(Z,aa),Ea);this.qbe.pzj(aa)}Hhj(Z){d.ULS.sendTraceTag(523337870,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: starting, raising CoauthVersionChanged event: ${c(Z)}`);this.tAi(this.Edc);this.Edc=Z;this.Pmk(this.Edc);this.crf();d.ULS.sendTraceTag(523337869,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: done ${this.getStatus()}`)}z6e(Z){if(Z)try{const bb=
JSON.parse(Z);var aa=bb.coauthVersionDocId,Ea=bb.coauthVersionXluid,za=bb.coauthVersionXrevId;return{DocId:"undefined"===aa?void 0:aa,Xluid:"undefined"===Ea?void 0:Ea,Xrevid:"undefined"===za?void 0:parseInt(za,10)}}catch(bb){d.ULS.sendTraceTag(523337868,0,10,`AugmentationLoopAnnotationValidator.extractWorkbookCoauthVersion(${Z}): Exception - ${bb}`)}}NMb(Z,aa,Ea){Ea=this.z6e(Ea);void 0!==Ea&&(d.ULS.sendTraceTag(523337867,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: starting ${Z}: ${aa.operationType}: (annotation id ${aa.annotation.id}) at ${c(Ea)}`),
this.CWg({annotationType:Z,NEe:aa},Ea),this.crf(),d.ULS.sendTraceTag(523337866,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: done ${this.getStatus()}`))}vId(Z,aa){return`${Z}_${aa}`}getStatus(){var Z,aa;const Ea=c(this.Edc),za=null===(Z=this.z9)||void 0===Z?void 0:Z.size;Z=null===(aa=this.OTa)||void 0===aa?void 0:aa.size;return`current coauth version: ${Ea}, ${za} known annotations, ${Z} coauth versions on hold`}fBc(Z,aa,Ea,za){const bb=this.z9.get(`${aa}`);Z=this.vId(Z,bb.annotationType);
d.ULS.sendTraceTag(523337865,0,50,`AugmentationLoopAnnotationValidator.raiseAnnotationEvent: ${Ea} raising ${Z} event (annotation id: ${aa})`);this.raiseEvent(Z,bb.NEe,this);this.qbe.e4i(bb.annotationType,`${aa}`,za)}WHi(Z,aa){aa=c(this.z6e(aa));Z=`${new fb(Z,aa)}`;return!this.z9.has(Z)}CWg(Z,aa){var Ea=Z.NEe.annotation.id;const za=c(aa);Ea=new fb(Ea,za);const bb=`${Ea}`;this.z9.has(bb)?d.ULS.sendTraceTag(523337864,0,50,`AugmentationLoopAnnotationValidator.addNewAnnotation: ignoring duplicate annotation (annotation id ${Ea})`):
(this.z9.set(bb,Z),this.X2.has(za)?this.X2.get(za).VKa.add(Ea.annotationId):this.X2.set(za,{VKa:new Set([Ea.annotationId]),timestamp:Date.now()}),Z=this.Edc,aa===Z||aa&&Z&&aa.DocId===Z.DocId&&aa.Xluid===Z.Xluid&&aa.Xrevid===Z.Xrevid?this.fBc("Valid",Ea,"addNewAnnotation","ValidOnArrival"):this.OTa.add(c(aa)))}u6f(Z){this.z9.delete(`${Z}`);for(let aa of this.X2.entries()){let [Ea,za]=aa;if(Ea===Z.coauthVersion&&za.VKa.delete(Z.annotationId))break}}BAj(){Array.from(this.X2.entries()).filter(Z=>{[,Z]=
Z;return 0===Z.VKa.size}).forEach(Z=>{[Z]=Z;return this.X2.delete(Z)})}A6f(Z){this.OTa.delete(Z)}tAi(Z){var aa;const Ea=c(Z);(new Set(null===(aa=this.X2.get(Ea))||void 0===aa?void 0:aa.VKa)).forEach(za=>{za=new fb(za,Ea);this.fBc("Invalid",za,"invalidateAnnotations","InvalidOnCoauthVersionChanged");this.u6f(za)})}Pmk(Z){var aa;Z=c(Z);if(this.OTa.has(Z)){var Ea=null===(aa=this.X2.get(Z))||void 0===aa?void 0:aa.VKa;aa=(aa=this.X2.get(Z))?Date.now()-aa.timestamp:0;for(const za of Ea)Ea=new fb(za,Z),
this.fBc("Valid",Ea,`validateAnnotations elapsed ${aa} ms`,"ValidAfterSomeTime");this.A6f(Z)}else d.ULS.sendTraceTag(523337863,0,50,`AugmentationLoopAnnotationValidator.validateAnnotations: ${Z} has no on-hold annotations associated with it`)}crf(){var Z=Date.now();const aa=[],Ea=[];for(const bb of this.OTa){var za=this.X2.get(bb);const Mb=Z-za.timestamp;if(Mb>this.n6e)for(const zb of za.VKa)za=new fb(zb,bb),this.fBc("Invalid",za,`invalidateExpiredAnnotations elapsed ${Mb} ms`,"InvalidAfterTimeout"),
aa.push(za)}for(const bb of aa)this.u6f(bb);for(const bb of this.OTa)Z=this.X2.get(bb),0===(null===Z||void 0===Z?void 0:Z.VKa.size)&&Ea.push(bb);for(const bb of Ea)this.A6f(bb);this.BAj()}}Object(e.a)(Pb,"AugmentationLoopAnnotationValidator",u.a,[645]);var Sa=a(151),Wa=a(6),pb=a(482),wa=a(198),hb=a(179),Sb=a(32),Bc=a(1032);class ab{sendMessage(Z){d.ULS.sendTraceTag(508965922,306,100,"AL send SDX message");Bc.a.INj(Z)}registerMessageReceivedCallback(Z){d.ULS.sendTraceTag(508965921,306,50,"AL handle SDX message");
Bc.a.tyj(Z)}}Object(e.a)(ab,"SdxMessageBridge",null,[706]);var qb=a(139),mc=a(57);class yb{constructor(){this.syncDeltaTimeout=this.disableSyncDeltaSending=this.isDeltaGeneratorEnabled=this.powerpoint=this.downloadPolymerBaseUrl=this.inferenceServiceVersion=this.downloadBaseUrl=this.sessionCreationOptions=this.disabledServiceGroups=this.privateMode=this.flights=this.excelServer=this.initSession=this.sessionId=this.releaseFork=this.releaseCustomAudience=this.releaseChannel=this.releaseAudienceGroup=
this.uiLanguage=this.appVersion=this.appName=this.serviceUrl=null}}Object(e.a)(yb,"InitializeParameters",null,[]);class vc{constructor(){this.userContext=this.enableRemoteExecutionNotification=this.networkMode=this.egress=this.localRegisteredWorkflows=this.enableComplexLocalWorkflows=this.serviceUrl=this.onServerAuthenticationStateChangeCallback=this.onSessionClose=this.onSessionReconnect=this.onSessionDisconnect=this.onSessionConnect=this.flights=this.extensionConfigs=this.docSessionId=null}}Object(e.a)(vc,
"SessionCreationOptions",null,[]);class Db{constructor(){this.featureEnabledCallback=null}}Object(e.a)(Db,"SetIsFeatureEnabledCallbackParameters",null,[]);class Ga{constructor(){this.requestAuthTokenCallback=null}}Object(e.a)(Ga,"SetRequestAuthTokenCallbackParameters",null,[]);class Eb{constructor(){this.sendOTelEvent=null}}Object(e.a)(Eb,"SetSendOTelEventCallbackParameters",null,[]);class Zb{constructor(){this.handler=null}}Object(e.a)(Zb,"SetSessionInitOverrideCallbackParameters",null,[]);class ic{constructor(){this.ulsLogger=
null}}Object(e.a)(ic,"SetULSLoggerParameters",null,[]);class mb extends Ba.a{constructor(){super();this.activeWorksheetId=this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.collabUserListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.workbookMetadataVersion=this.ecsOperationUrl=this.restUrl=this.ecsId=this.cluster=null;this.H_=Object.assign(new I.a,{T_:mb.getTypeName(),B_:mb.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelServerSessionExtensionConfig"}static getBaseTypes(){return[]}}
Object(e.a)(mb,"ExcelServerSessionExtensionConfig",Ba.a,[]);var Hb=a(871),Wb=a(92),Ob=a(177);Object(Sa.b)(ib.h,{Ux:"singleton"})(Z=>Io(function*(){var aa;if(y.EwaSettings.isChangeGateEnabled("OfficeVSO:8031739_AddUsageTelemetryToNewAugloopFactory")){var Ea=Date.now();try{var za=yield Sa.a.resolve(ib.R,Z);const bb=yield Sa.a.resolve(ib.Nb,Z),Mb=yield Gc.fGd(za,bb,null!==(aa=null===Z||void 0===Z?void 0:Z.Qa)&&void 0!==aa?aa:0);h.Health.instance.recordKpiUsageForAlertableKpi("AugmentationLoopManagerCreation",
"xlalint",null);return Mb}catch(bb){throw h.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation","Exception",!1,!0,Object(f.a)(new Ob.a,{extendedProperties:new Map,durationMs:Date.now()-Ea})),bb;}}else return aa=yield Sa.a.resolve(ib.R,Z),za=yield Sa.a.resolve(ib.Nb,Z),Gc.fGd(aa,za,null!==(Ea=null===Z||void 0===Z?void 0:Z.Qa)&&void 0!==Ea?Ea:0)}));class Gc{static fGd(Z,aa,Ea){if(Gc.s9b)return d.ULS.sendTraceTag(537170369,0,15,"augloop: LoadAndInitializeAugLoopRuntimeManager called more than once"),
Gc.s9b;const za=Wa.AFrameworkApplication.fa.Ta("AugLoopCloudALServiceUrl");if(!za||!za.length)return d.ULS.sendTraceTag(537170368,0,15,"AugmentationLoopRuntimeProxy.LoadAndInitializeAugLoopRuntimeManager: AugLoopCloudALServiceUrl is null or empty"),Promise.reject(null);Ea=Wb.b(mc.a.loadScript(82,4,Ea,void 0,void 0,327));Gc.s9b=Ea.then(()=>{const bb=augLoop.ALFactoryGlobal.getAugLoopRuntimeManager();Gc.Hwi(Z,aa,bb);return Promise.resolve(bb)}).catch(bb=>{d.ULS.sendTraceTag(537170339,0,10,"augloop: Failed to download script:"+
bb);return Promise.reject(null)});return Gc.s9b}static Hwi(Z,aa,Ea){var za,bb;d.ULS.sendTraceTag(537170338,0,50,"augloop: Successfully loaded script");Gc.oj||Gc.VPj(t.a.$a);Gc.oAd=new Set;d.ULS.sendTraceTag(522803219,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: setIsFeatureEnabledCallback");Ea.setIsFeatureEnabledCallback(Object(f.a)(new Db,{featureEnabledCallback:oa=>{const Xa=Wa.AFrameworkApplication.fa.qa("AugLoop"+oa),bc=y.EwaSettings.getBooleanFeatureGate(oa,!1),Ac=y.EwaSettings.getBooleanFeatureGate("AugLoop"+
oa,!1);var Xc=y.EwaSettings.isChangeGateEnabled("OfficeVSO:7781753_ALIsFeatureEnabledHandleExcelPrefix")&&y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel."+oa,!1);Xc=bc||Ac||Xc;const Ed=Xa||Xc;Gc.oAd.has(oa)||(Gc.oAd.add(oa),d.ULS.shipAssertTag(537170337,0,!(Xa&&!Xc),`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: legacy app setting return true for feature ${oa}, but feature gate return false. This is problem because app setting is depricated and about to be removed`),
Ed&&d.ULS.sendTraceTag(537170336,0,50,`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: feature ${oa} is enabled. legacyAppSettingResult: ${Xa}, featureGateWithoutPrefix: ${bc}, featureGateWithPrefix: ${Ac}`));return Ed}}));if(aa){var Mb=Gc.sjc(aa);Mb=Gc.sjc(aa,Wa.AFrameworkApplication.fa.Ta("AugloopACLPUserDataSignature"));d.ULS.sendTraceTag(522803218,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: Callback is passed to the augloop runtime which calls the code  when an auth token is required");
Ea.setRequestAuthTokenCallback(Object(f.a)(new Ga,{requestAuthTokenCallback:Mb}))}else d.ULS.sendTraceTag(537170335,0,10,"Oauth manager is null");d.ULS.sendTraceTag(522803217,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setULSLogger");Ea.setULSLogger(Object(f.a)(new ic,{ulsLogger:new pb.a}));d.ULS.sendTraceTag(522803216,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSendOTelEventCallback");Ea.setSendOTelEventCallback(Object(f.a)(new Eb,
{sendOTelEvent:Gc.sendOTelEvent}));aa=new Map;Mb=y.EwaSettings.x8h();for(const oa of Mb){const [Xa,bc]=oa;aa.set(Xa,String(bc))}y.EwaSettings.Da(387)&&aa.set("EnterpriseDataTypeMipSupport",void 0);(y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintExperiment",!1)||y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintProdExperiment",!1)||y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligence",!1)||y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",
!1))&&aa.set("LoadAdditionalDataToModel",void 0);y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.DataCleansingTaskPane",!1)&&(aa.set("DataCleansingSlice0",void 0),aa.set("LoadAdditionalDataToModel",void 0));y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopNoLatency",!1)&&(aa.set("AugloopNoLatency",void 0),y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.DataCleansingEnableNewLintersForBetaUsers",!1)||(aa.set("Microsoft.Office.Excel.AugmentationLoopTableLintSynonymCheck",
"false"),aa.set("Microsoft.Office.Excel.AugmentationLoopTableLintFuzzyMatch","false")));y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableLintInvestigationTelemetry",!1)&&aa.set("TableLintInvestigationTelemetry",void 0);y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TelemetryWorkflowIncludeTextHints",!1)&&aa.set("TelemetryWorkflowIncludeTextHints",void 0);y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.Insights.UseTableRecoMLTableIntelligence",!1)&&aa.set("UseTableRecoMLTableIntelligence",
void 0);y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceLogging",!1)&&aa.set("TableIntelligenceLogging",void 0);y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopWaitForWorkbookChangeState",!1)&&aa.set("AugloopWaitForWorkbookChangeState",void 0);y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.SeedWithAugloopFetchRangeOperation",!1)&&aa.set("SeedWithAugloopFetchRangeOperation",void 0);y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALReadMetadataFromUserEcsSession",
!1)&&aa.set("XLALReadMetadataFromUserEcsSession",void 0);y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALWorksheetScopingEnable",!1)&&aa.set("XLALWorksheetScopingEnable",void 0);y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UseTableSenseML",!1)&&aa.set("UseTableSenseML",void 0);y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableSenseOnAML",!1)&&aa.set("TableSenseOnAML",void 0);y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThreshold",
!1)&&(null===(za=null===Z||void 0===Z?void 0:Z.va)||void 0===za?0:za.count)&&Z.va.count>y.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThresholdValue",100)&&(aa.set("TableIntelligenceSheetCountThreshold",void 0),d.ULS.sendTraceTag(521151777,306,50,`TableIntelligence max sheet count exceeded. SheetCount: ${Z.va.count}`));za=y.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.ProactiveSuggestionIsPivotableThreshold",-1);-1!==za&&aa.set("Microsoft.Office.Excel.ProactiveSuggestionIsPivotableThreshold",
za.toString());za=y.EwaSettings.r7h();for(var zb of za)aa.set(zb,"false");d.ULS.sendTraceTag(522803215,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setInitSessionCallback");Ea.setInitSessionCallback({initSessionCallback:()=>{var oa;if(null===(oa=null===Z||void 0===Z?void 0:Z.da)||void 0===oa?0:oa.sessionId)return d.ULS.sendTraceTag(527708568,0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is valid (length = ${Z.da.sessionId.length}), return resolved promise`),
Promise.resolve();d.ULS.sendTraceTag(527708567,0,50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is not valid, return promise that will be resolved when session id will be valid again.");return new Promise(Xa=>{var bc;const Ac=()=>{var Xc;(null===(Xc=null===Z||void 0===Z?void 0:Z.da)||void 0===Xc?0:Xc.sessionId)?(d.ULS.sendTraceTag(527708566,0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called with valid session id (length = ${Z.da.sessionId.length}), resolve the promise and unregister the callback.`),
Z.da.Vl(Ac),Xa()):d.ULS.sendTraceTag(527708565,0,50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called, but the session id is not valid yet, keep waiting.")};null===(bc=null===Z||void 0===Z?void 0:Z.da)||void 0===bc?void 0:bc.Pl(Ac)})}});d.ULS.sendTraceTag(522803214,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSessionInitOverrideCallback");Ea.setSessionInitOverrideCallback(Object(f.a)(new Zb,{handler:oa=>{var Xa;oa.extensionConfigs=
[Object(f.a)(new mb,{cluster:Z.xa.MachineCluster,ecsId:Gc.P7h(Z),restUrl:Z.xa.RestActionUrl,ecsOperationUrl:"",workbookMetadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,collabUserListVersion:0,collabStateId:0,accessToken:Z.xa.AccessToken,accessTokenTTL:Z.xa.AccessTokenValidTo.toString(),activeWorksheetId:null!==(Xa=Object(ya.d)(Z.na))&&void 0!==Xa?Xa:void 0})];d.ULS.sendTraceTag(509682397,0,50,`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: access token TTL ${Z.xa.AccessTokenValidTo.toString()}, activeWorksheetId ${Object(ya.d)(Z.na)}`);
return oa}}));d.ULS.sendTraceTag(522803213,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.initialize - onSessionClose: getOnCloseMessageCallback ");zb=null!==(bb=this.Y2h())&&void 0!==bb?bb:Wa.AFrameworkApplication.fa.Ta("AugLoopCloudALServiceUrl");Ea.initialize(Object(f.a)(new yb,{serviceUrl:zb,appName:"Excel",appVersion:Wa.AFrameworkApplication.fa.Ta("BuildVersion")||"",releaseAudienceGroup:Wa.AFrameworkApplication.fe?Object(qb.a)(String,Wa.AFrameworkApplication.fe.AudienceGroup)||
"":"",releaseChannel:null,releaseFork:null,sessionId:Z.xa.UserSessionId,initSession:!0,flights:this.lnh(aa),uiLanguage:Wa.AFrameworkApplication.uiCulture,excelServer:null,sessionCreationOptions:Object(f.a)(new vc,{onSessionConnect:y.EwaSettings.isChangeGateEnabled("OfficeVSO:8028144_XLO-AugLoop-SessionConnect")?Gc.kdi():null,onSessionClose:y.EwaSettings.isChangeGateEnabled("OfficeVSO:7997614_ImproveLoggingInOnCloseMessageCallback")?Gc.idi():Gc.jdi()})}));y.EwaSettings.isChangeGateEnabled("OfficeVSO:7785803_XLO-AugLoop-SdxMessageBridge")&&
Ea.setMessageBridge({bridge:new ab})}static Y2h(){var Z,aa=Z||(Z={});aa[aa.Test=1]="Test";aa[aa.Int=2]="Int";aa[aa.DogFood=3]="DogFood";aa[aa.Prod=4]="Prod";aa[aa.LocalHost=5]="LocalHost";Object(e.b)("AugLoopEndpointType",Z);Z={[Z.Test]:"https://augloop-test.officeppe.com",[Z.Int]:"https://augloop-int.officeppe.com",[Z.DogFood]:"https://augloop-dogfood.officeppe.com",[Z.Prod]:"https://augloop.office.com",[Z.LocalHost]:"http://localhost:20080"};aa=Wa.AFrameworkApplication.fa.getIntFeatureGate("Microsoft.Office.Excel.Augloop.EndpointOverride",
0);return Z[aa]}static lnh(Z){return Array.from(Z.entries()).map(aa=>{var [Ea,za]=aa;return void 0!==za?`${Ea}:${za}`:Ea}).map(aa=>aa+";").join("")}static idi(){function Z(aa,Ea){return wa.a.instance.cQ(Wa.AFrameworkApplication.accessTokenTtl)?(d.ULS.sendTraceTag(537170330,0,15,"AugmentationLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: access token has expired"),!1):aa?Ea?(d.ULS.shipAssertTag(509658147,0,!(void 0===Ea.errorType||null===Ea.errorType),"AugmentationLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: closeReason.errorType is null"),
null==Ea.errorType||2===Ea.errorType):!0:(d.ULS.shipAssertTag(537170331,0,!1,"AugmentationLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: - closeMessage is null"),!0)}return aa=>{const Ea=null===aa||void 0===aa?void 0:aa.reason,za=Z(aa,Ea),bb=null===Gc.LFa?void 0:z.a(Gc.oj,Gc.LFa);var Mb;if(Mb=za)(void 0===bb||bb>Gc.GBc)&&Gc.B$f(),(Mb=Gc.rVa>=Gc.qLb)?d.ULS.sendTraceTag(537170327,0,15,`AugmentationLoopRuntimeProxy.maxReconnectAttemptsReached: Reached the limit of ${Gc.qLb} attempts for session creation under interval of ${Gc.GBc} Ms. Stop trying to reconnect. Time of first attempt in this iterval: ${Gc.LFa}.`):
Gc.rVa++,Mb=!Mb;d.ULS.sendTraceTag(508630688,0,50,`AugmentationLoopRuntimeProxy.getOnCloseMessageCallback: ${JSON.stringify({errorType:Za[null===Ea||void 0===Ea?void 0:Ea.errorType],shouldRetryBasedOnCloseMessage:za,reconnecting:Mb,reconnectsCounter:Gc.rVa,millisecondsSinceFirstReconnectInInterval:bb,closeMessage:aa})}`);Gc.CMd(Mb,null===Ea||void 0===Ea?void 0:Ea.errorType,null===Ea||void 0===Ea?void 0:Ea.errorCode)}}static jdi(){return Z=>{let aa=!wa.a.instance.cQ(Wa.AFrameworkApplication.accessTokenTtl);
const Ea=null===Z||void 0===Z?void 0:Z.reason;aa?Z?Z.reason&&(d.ULS.shipAssertTag(509658147,0,!(void 0===Ea.errorType||null===Ea.errorType),"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: closeReason.errorType is null"),aa&&(aa=null==Ea.errorType||2===Ea.errorType)):d.ULS.shipAssertTag(537170331,0,!1,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: - closeMessage is null"):d.ULS.sendTraceTag(509727632,0,15,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: access token has expired");
d.ULS.sendTraceTag(509727632,0,50,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: is called with shouldRetry: ${aa},
        errorType: ${Za[null===Ea||void 0===Ea?void 0:Ea.errorType]},
        errorCode: ${null===Ea||void 0===Ea?void 0:Ea.errorCode},
        isExpected: ${null===Ea||void 0===Ea?void 0:Ea.isExpected}`);aa&&((!Gc.LFa||z.a(Gc.oj,Gc.LFa)>Gc.GBc)&&Gc.B$f(),Gc.rVa<Gc.qLb?(Gc.rVa++,d.ULS.sendTraceTag(537170328,0,50,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Start new session attempt ${Gc.rVa} of ${Gc.qLb}. Time of first attempt in this interval of reconnects: ${Gc.LFa}`)):(d.ULS.sendTraceTag(508630684,0,15,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Reached the limit of ${Gc.qLb} attempts for session creation under interval of ${Gc.GBc} Ms. Stop trying to reconnect. Time of first attempt in this iterval: ${Gc.LFa}.`),
aa=!1));Gc.CMd(aa,null===Ea||void 0===Ea?void 0:Ea.errorType,null===Ea||void 0===Ea?void 0:Ea.errorCode)}}static kdi(){return(Z,aa)=>{Z=aa.substring(aa.lastIndexOf("/")+1);d.ULS.sendTraceTag(508622662,0,50,`AugmentationLoopRuntimeProxy.getOnConnectMessageCallback: sessionKey ${Z}.`)}}static pfg(Z){Gc.CMd=Z}static VPj(Z){Gc.oj=Z}static B$f(){Gc.rVa=0;Gc.LFa=Gc.oj.Wd}static sjc(Z,aa){aa=void 0===aa?"":aa;return()=>{try{return d.ULS.sendTraceTag(527970953,0,50,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: called with fallbackValue.length: ${aa.length}.`),
Z.rE("AugLoop",Wa.AFrameworkApplication.fa.Ta("AugLoopOAuthResourceUriV2")).then(Ea=>{if(Ea.IsSuccess)return d.ULS.sendTraceTag(527970952,0,50,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: successfully fetch token."),Ea.Token;d.ULS.sendTraceTag(537170326,0,15,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: failed to get token, use fallback value (length: ${aa.length})`);return aa},()=>{d.ULS.sendTraceTag(537170325,0,15,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: got rejected promise, use fallback value");
return aa})}catch(Ea){return d.ULS.sendTraceTag(537170324,0,10,"Exception thrown when fetching token"),Promise.resolve(aa)}}}static sendOTelEvent(Z){hb.a.sendOtelEvent(Object(f.a)(new Hb.a,{otelEvent:Z}))}static P7h(Z){const aa=Sb.a.Rg(Z.da.sessionId);Z=`cluster=${Z.xa.MachineCluster}&session=${aa}&usid=${Z.xa.UserSessionId}`;y.EwaSettings.isChangeGateEnabled("OfficeVSO:5897059_XLALInvestigateIncorrectSessionId")&&d.ULS.sendTraceTag(528348230,0,50,`AugmentationLoopRuntimeProxy.getEcsSessionId: ecsSessionId length is ${Z.length}`);
return Z}}Gc.qLb=3;Gc.GBc=3E5;Gc.rVa=0;Gc.LFa=null;Gc.oj=null;Gc.s9b=null;Gc.CMd=null;Gc.oAd=null;Object(e.a)(Gc,"AugmentationLoopRuntimeProxy",null,[]);class Va{constructor(){this.z9=new Map}NMb(Z,aa){d.ULS.sendTraceTag(508913554,0,50,`AnnotationPool.onAnnotationReceived: ${JSON.stringify({annotationId:aa.annotation.id,annotationType:Z,operationType:aa.operationType})}`);this.z9.set(aa.annotation.id,{annotationType:Z,annotationEventArgs:aa})}d4i(Z){const aa=this.z9.delete(Z);d.ULS.sendTraceTag(508913553,
0,50,`AnnotationPool.onAnnotationDeletion: annotationId: ${JSON.stringify({annotationId:Z,hasBeenInThePool:aa})}`)}oaf(Z){return this.z9.get(Z)}}Object(e.a)(Va,"AnnotationPool",null,[]);var Jb;(function(Z){Z[Z.FullyActive=0]="FullyActive";Z[Z.ClosedAndWaitingOnlyForNonModelRequiredActivation=1]="ClosedAndWaitingOnlyForNonModelRequiredActivation";Z[Z.ActiveForNonModelRequired=2]="ActiveForNonModelRequired";Z[Z.Closed=3]="Closed"})(Jb||(Jb={}));Object(e.b)("AugmentationLoopServerStatus",Jb);let ub=
class extends u.a{constructor(Z,aa,Ea,za){Ea=void 0===Ea?new Pb(Z.xa.AugmentationLoopAnnotationExpirationTimeoutInMs):Ea;za=void 0===za?t.a.$a:za;var bb,Mb;super();this.$=Z;this.x6=aa;this.WKa=Ea;this.oj=za;this.x8b=new Va;this.wqa=null;this.isObserverRequired=!1;this.kh=null;this.uS=Jb.FullyActive;this.Y$=new Map;this.Eub=[];this.vSh=new Map([[0,"Unknown"],[1,"Permanent"],[2,"Permanent"],[3,"ModelWorkflowNotSupported"]]);this.Fub=!1;this.XNc=new n;this.VFb=y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopIncrementalChangesPhase1",
!1);this.CVd=y.EwaSettings.isChangeGateEnabled("OfficeVSO:8059124_removeReportingNonemptyCLPAnnotations");this.Qe=(zb,oa)=>{oa.aI&&this.$.da.sessionId&&(d.ULS.sendTraceTag(537170394,0,50,`AugmentationLoopManager.onSessionIdChanged: Update augmentation loop server on new ECS Session ID: '${this.$.da.sessionId}'`),this.x6.forceReconnectSession(Object(f.a)(new F,{excelServerParameters:Object(f.a)(new J,{wacCluster:this.$.xa.MachineCluster,ecsSessionId:this.$.da.sessionId,ecsRestUrl:this.$.xa.RestActionUrl,
ecsOperationUrl:"",metadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,userListVersion:0,collabStateId:0,accessToken:this.$.xa.AccessToken,accessTokenTTL:this.$.xa.AccessTokenValidTo.toString()})})).catch(Xa=>{d.ULS.sendTraceTag(526406272,0,50,`AugmentationLoopManager.onSessionIdChanged: forceReconnectSession promise rejected with error ${Xa}`)}),y.EwaSettings.isChangeGateEnabled("OfficeVSO:7578618_ObserverRequiredNotificationsToECSOnlyInEditMode")?this.Eib(this.isObserverRequired,
"onSessionIdChanged"):(d.ULS.sendTraceTag(528348225,0,50,`AugmentationLoopManager.onSessionIdChanged: sending ObserverRequiredNotification, isSeedingRequired: ${this.isObserverRequired}`),this.Eib(this.isObserverRequired)))};this.Vf=(zb,oa)=>{zb=Object(ya.p)(oa.na)?Object(ya.d)(oa.na):this.activeWorksheetId;oa=y.EwaSettings.isChangeGateEnabled("OfficeVSO:7547289_ALCloseALSessionOnInvalidAccessToken")?this.tLe()&&zb&&zb!==this.activeWorksheetId:zb&&zb!==this.activeWorksheetId;this.activeWorksheetId=
zb;oa&&(this.vcb=this.oj.Wd,d.ULS.sendTraceTag(520677595,0,50,`AugmentationLoopManager.onActiveItemChanged: Submitting keepalive custom message. activeSheetId ${this.activeWorksheetId}`),this.Wdg())};this.WMb=(zb,oa,Xa)=>{if(this.uS===Jb.Closed)d.ULS.shipAssertTag(509682971,0,!1,"AugmentationLoopManager.onCloseMessage: Called while augmentation loop server is closed. Avoiding with early return");else{d.ULS.sendTraceTag(509727633,0,50,`AugmentationLoopManager.onCloseMessage called with shouldRetry: ${zb}, errorType: ${Za[oa]}, errorCode: ${Xa}`);
if(zb)this.Y5d();else switch(zb=this.uSh(oa),this.udh(zb,Xa),oa){case 3:this.Fub?(this.uS=Jb.ActiveForNonModelRequired,this.Y5d()):(this.uS=Jb.ClosedAndWaitingOnlyForNonModelRequiredActivation,this.hJc());break;case 1:case 0:this.uS=Jb.Closed,this.hJc()}y.EwaSettings.isChangeGateEnabled("OfficeVSO:7578618_ObserverRequiredNotificationsToECSOnlyInEditMode")?this.Eib(!1,"onCloseMessage"):this.$.da.sessionId&&(d.ULS.sendTraceTag(520679430,0,50,"AugmentationLoopManager.onCloseMessage: sending ObserverRequiredNotification, isSeedingRequired: false"),
this.Eib(!1))}};this.oe=(zb,oa)=>{if(oa.Fh)d.ULS.sendTraceTag(520677599,0,50,"AugmentationLoopManager.onWorkbookClosing: event triggered due to silent reopen. Avoiding event with early return");else if(d.ULS.sendTraceTag(537170381,0,50,`AugmentationLoopManager.onWorkbookClosing: handler invoked
      (IsAppBeforeUnload == ${this.$.$Qa}, IsAppUnloading == ${this.$.xK}.`),this.$.$Qa||this.$.xK)this.hJc(),this.x6.closeSession().catch(Xa=>{d.ULS.sendTraceTag(526406240,0,50,`AugmentationLoopManager.onWorkbookClosing: closeSession promise rejected with error ${Xa}`)})};this.B3a=zb=>{d.ULS.sendTraceTag(537170380,0,50,"Annotation Received");if(zb)if(zb.items){var oa=0;({value:oa}=this.wqa.Ve(Ba.a.y8(zb),0));0===oa?d.ULS.sendTraceTag(537170377,0,10,"AugmentationLoopManager.annotationCallback: Operation Type not supported "+
Ba.a.y8(zb)):y.EwaSettings.isChangeGateEnabled("OfficeVSO:7746271_IntroduceDeleteAnnotationEvent")&&3===oa?this.Bni(zb):this.Ymi(zb,oa)}else d.ULS.sendTraceTag(537170378,0,10,"AugmentationLoopManager.annotationCallback: Operation has no items");else d.ULS.sendTraceTag(537170379,0,10,"AugmentationLoopManager.annotationCallback: Operation is null")};this.WD=(zb,oa)=>{-1!==oa.gJf&&(this.ptc=Object(f.a)(new v,{stateId:oa.gJf,Zae:this.oj.Wd}))};this.jDa=()=>{const zb=z.b(this.oj,this.vcb);if(y.EwaSettings.isChangeGateEnabled("OfficeVSO:7547289_ALCloseALSessionOnInvalidAccessToken"))var oa=
this.tLe()&&this.BJd<=zb;else{oa=this.$.da.f2;const Xa=this.$.da.g_;oa=this.BJd<=zb&&Xa<this.BYa&&!oa}oa?(this.vcb=this.oj.Wd,d.ULS.sendTraceTag(509682396,0,50,`AugmentationLoopManager.onUserActivityThrottled: Submitting keepalive custom message. secondsSinceLastKeepAlive: ${zb}`),this.Wdg()):this.BJd<=zb&&d.ULS.sendTraceTag(520632032,0,50,`AugmentationLoopManager.onUserActivityThrottled: Not submitting keepalive custom message. secondsSinceLastKeepAlive: ${zb}`)};this.b3i=(zb,oa)=>{zb=oa.annotation;
d.ULS.shipAssertTag(537170373,306,!!zb,"AugmentationLoopManager.ObserverStatusAnnotationHandler: ObserverStatusAnnotation is null.");d.ULS.sendTraceTag(520677594,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: received ${JSON.stringify(zb)}`);this.isObserverRequired=zb.isSeedingRequired&&zb.isObserverRequired;y.EwaSettings.isChangeGateEnabled("OfficeVSO:7578618_ObserverRequiredNotificationsToECSOnlyInEditMode")?this.Eib(this.isObserverRequired,"observerStatusAnnotationHandler"):this.$.da.sessionId&&
(d.ULS.sendTraceTag(520677593,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: sending ObserverRequiredNotification, isObserverRequired: ${this.isObserverRequired}`),this.Eib(this.isObserverRequired))};this.wYb=(zb,oa)=>{var Xa;(null===(Xa=null===oa||void 0===oa?void 0:oa.rf)||void 0===Xa?0:Xa.WorkbookCoauthVersion)&&this.Ihj(oa.rf.WorkbookCoauthVersion,oa.context)};this.vcb=this.oj.Wd;this.activeWorksheetId=null!==(bb=Object(ya.d)(Z.na))&&void 0!==bb?bb:this.activeWorksheetId;d.ULS.sendTraceTag(520679433,
0,50,`AugmentationLoopManager.constructor: setAnnotationResultCallback ${null===(Mb=this.B3a)||void 0===Mb?void 0:Mb.name}, activeWorksheetId ${this.activeWorksheetId}`);this.x6.setAnnotationResultCallback(Object(f.a)(new L,{handler:this.B3a}));this.Oxi();this.$.da.YE(this.WD);this.$.sk(this.oe);this.ptc=Object(f.a)(new v,{stateId:0,Zae:this.oj.Wd});this.$.ea.Ja(328,this);this.BJd=this.$.xa.MinimumSecondsBetweenKeepAlivesFromBrowserToAugloop;this.BYa=60*this.$.xa.UserActiveTimeSinceLastActivityInMinutes;
this.$.da.Pl(this.Qe);this.$.Gd.Fi(this.Vf);this.$.va.Fi(this.Vf);this.$.pa.Ht(this.wYb);this.wvi();this.Hxj();y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.MigrateAugmentationLoopToNewServiceInfra",!1)&&Gc.pfg(this.WMb)}wvi(){y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopTableLintRecognitionPullWorkflowsCompare",!1)&&this.Eub.push("ExcelTableRecognitionReducer");y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopTableLint_SecurityClassificationExcelGridPullWorkflow",
!1)&&(y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FilterOutLegacyLabellingAnnotation",!1)?this.Eub.push("SecurityLabellingReduce"):this.Eub.push("SecurityLabellingMetadataReduce"));y.EwaSettings.isChangeGateEnabled("OfficeVSO:7976995_mitigate_5co93")&&d.ULS.sendTraceTag(508683610,0,50,`AugmentationLoopManager.initFilteredOutAnnotations: ${this.Eub.join(",")}`)}tLe(){const Z=this.$.da.f2;return 300>this.$.da.g_&&!Z}Wdg(){this.x6.submitCustomMessage(Object(f.a)(new S,{message:Object(f.a)(new pa,
{activeWorksheetId:this.activeWorksheetId})})).catch(Z=>{d.ULS.sendTraceTag(526406239,0,10,`AugmentationLoopManager.sendExcelKeepAliveMessage: submitCustomMessage promise rejected with error ${Z}`)})}YX(){return new da}KUg(Z){Z.AN&&this.DWg(Z.annotationType,Z.AN);this.VFb?Z.zgd&&this.AVg(Z.annotationType,Z.zgd):(Z.Tlb&&this.WKa.Wze("Valid",Z.annotationType,Z.Tlb),Z.Foc&&this.WKa.Wze("Invalid",Z.annotationType,Z.Foc))}X5f(Z){Z.AN&&this.gAj(Z.annotationType,Z.AN);this.VFb?Z.zgd&&this.Dzj(Z.annotationType,
Z.zgd):(Z.Tlb&&this.WKa.W5f("Valid",Z.annotationType,Z.Tlb),Z.Foc&&this.WKa.W5f("Invalid",Z.annotationType,Z.Foc))}register(Z){let aa=null,Ea;this.Y$.has(Z.featureName)?(aa=`${Z.featureName} is already registered. Ignoring new registration.`,Ea="AlreadyRegisteredFailure"):this.uS===Jb.Closed&&(aa=`Augmentation loop server is permanently closed. Cannot register ${Z.featureName}.`,Ea="ServerClosedFailure");if(aa)return d.ULS.sendTraceTag(509649306,0,15,`AugmentationLoopManager.register: ${aa}`),Ea;
d.ULS.sendTraceTag(509686223,0,50,`AugmentationLoopManager.register: Registering ${Z.featureName}`);this.Y$.set(Z.featureName,Z);Z.annotations.forEach(za=>this.W4f(Z.featureName,za));return"Success"}unregister(Z){const aa=this.Y$.get(Z);if(!aa)return d.ULS.sendTraceTag(509686220,0,15,`AugmentationLoopManager.unregister: feature ${Z} is not registered`),"UnregisteredFeatureFailure";d.ULS.sendTraceTag(509686221,0,50,`AugmentationLoopManager.unregister: unregister ${Z}`);aa.annotations.forEach(Ea=>{this.X5f(Ea)});
this.Y$.delete(Z);this.Fub=b(this.Y$);return"Success"}uSh(Z){var aa;return null!==(aa=this.vSh.get(Z))&&void 0!==aa?aa:"Unknown"}Juj(){switch(this.uS){case Jb.FullyActive:this.Y$.forEach(Z=>{Z.annotations.forEach(aa=>{this.activateAnnotation(aa)})});break;case Jb.ActiveForNonModelRequired:this.Y$.forEach(Z=>{Z.annotations.filter(aa=>!aa.Yt).forEach(aa=>{this.activateAnnotation(aa)})});break;case Jb.ClosedAndWaitingOnlyForNonModelRequiredActivation:case Jb.Closed:d.ULS.shipAssertTag(509661458,0,!1,
`AugmentationLoopManager.reactivateAnnotationsBasedOnModelSupported: Called while augmentation loop server is ${Jb[this.uS]}`)}}Uuc(Z){return`New_${Z}`}tId(Z){return`Delete_${Z}`}DWg(Z,aa){d.ULS.sendTraceTag(520679429,0,50,`AugmentationLoopManager.addNewAnnotationCallback: annotationType: ${Z}, handler: ${null===aa||void 0===aa?void 0:aa.name}`);this.addHandler(this.Uuc(Z),aa)}gAj(Z,aa){d.ULS.sendTraceTag(509686219,0,50,`AugmentationLoopManager.removeNewAnnotationCallback: annotationType: ${Z}, handler: ${null===
aa||void 0===aa?void 0:aa.name}`);this.removeHandler(this.Uuc(Z),aa)}AVg(Z,aa){d.ULS.sendTraceTag(508913552,0,50,`AugmentationLoopManager.addDeleteAnnotationCallback: annotationType: ${Z}, handler: ${null===aa||void 0===aa?void 0:aa.name}`);this.addHandler(this.tId(Z),aa)}Dzj(Z,aa){d.ULS.sendTraceTag(508913551,0,50,`AugmentationLoopManager.removeDeleteAnnotationCallback: annotationType: ${Z}, handler: ${null===aa||void 0===aa?void 0:aa.name}`);this.removeHandler(this.tId(Z),aa)}jVg(Z){d.ULS.sendTraceTag(520679427,
0,50,"AugmentationLoopManager.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChanged",Z)}W4f(Z,aa){if(this.uS!==Jb.FullyActive&&aa.Yt)return d.ULS.sendTraceTag(509650462,0,50,`AugmentationLoopManager.registerAnnotationInternal: Augmentation loop server does not support model workflow. Cannot activate ${aa.annotationType}.`),!1;if(aa.isInternal){if([Jb.ClosedAndWaitingOnlyForNonModelRequiredActivation,Jb.Closed].includes(this.uS))return!1}else this.Fub||(this.Fub=!aa.Yt),this.A5j(!aa.Yt),
this.vng();this.activateAnnotation(Object.assign({},aa,{featureName:Z}));this.KUg(aa);return!0}X$(Z,aa){let Ea=null,za;const bb=this.Y$.get(Z);bb?bb.annotations.some(Mb=>aa.annotationType===Mb.annotationType)?(Ea=`Annotation ${aa.annotationType} is already registered for feature ${Z}.`,za="AlreadyRegisteredFailure"):this.uS===Jb.Closed&&(Ea=`Augmentation loop server is permanently closed. Cannot activate ${aa.annotationType}.`,za="ServerClosedFailure"):(Ea=`Feature ${Z} is not registered. Cannot register ${aa.annotationType}.`,
za="UnregisteredFeatureFailure");if(Ea)return d.ULS.sendTraceTag(509682975,0,15,`AugmentationLoopManager.registerAnnotation: ${Ea}`),za;d.ULS.sendTraceTag(509686218,0,50,`AugmentationLoopManager.registerAnnotation: Registering annotation ${aa.annotationType} for feature ${Z}.`);this.W4f(Z,aa)&&bb.annotations.push(aa);return"Success"}Ffk(Z){const aa=this.Y$.get("AutoPolicy");if(aa){d.ULS.sendTraceTag(509367457,0,50,`AugmentationLoopManager.unregisterAnnotation: Unregister annotation ${Z} for feature ${"AutoPolicy"}.`);
var Ea=aa.annotations.findIndex(za=>za.annotationType===Z);-1!==Ea&&(this.X5f(aa.annotations[Ea]),aa.annotations.splice(Ea,1),this.Fub=b(this.Y$))}else d.ULS.sendTraceTag(509367458,0,15,"AugmentationLoopManager.unregisterAnnotation: Feature AutoPolicy is not registered.")}Y5d(){d.ULS.sendTraceTag(509661457,0,50,"AugmentationLoopManager.startNewALSession: Starting new AL session.");this.x6.startNewSession();this.vng();this.Juj()}A5j(Z){d.ULS.shipAssertTag(509650461,0,this.uS!==Jb.Closed,"AugmentationLoopManager.startNewALSessionIfNecessary: Called while augmentation loop server is closed permanently.");
this.uS===Jb.ClosedAndWaitingOnlyForNonModelRequiredActivation&&Z&&(this.uS=Jb.ActiveForNonModelRequired,this.Y5d())}activateAnnotation(Z){d.ULS.sendTraceTag(520679425,0,50,`AugmentationLoopManager.activateAnnotation: Activating annotation type: ${Z.annotationType}.`);y.EwaSettings.isChangeGateEnabled("OfficeVSO:6044361_XLALCatchPromiseFailures")?this.x6.activateAnnotation(Object(f.a)(new C,{annotationType:Z.annotationType,stateUpdateHandler:Z.PEe})).then(aa=>{aa||d.ULS.sendTraceTag(520677603,0,10,
"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null}).catch(aa=>{d.ULS.sendTraceTag(520677602,0,50,`AugmentationLoopManager.activateAnnotation: activateAnnotation promise rejected with error ${aa}`)}):this.x6.activateAnnotation(Object(f.a)(new C,{annotationType:Z.annotationType,stateUpdateHandler:Z.PEe})).then(aa=>{aa||d.ULS.sendTraceTag(520677601,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null})}submitOperation(Z){if(!Z)return d.ULS.shipAssertTag(537170387,
0,!1,"AugmentationLoopManager.submitOperation: operation is null"),"InvalidParameterFailure";d.ULS.sendTraceTag(537170386,0,50,`AugmentationLoopManager.submitOperation: submitting operation of type '${Ba.a.y8(Z)}'`);this.x6.submitOperation(Object(f.a)(new W,{operation:Z}));return"Success"}ekb(Z){if(Z){var aa=Object.getTypeName(Z);d.ULS.sendTraceTag(537170384,0,50,`AugmentationLoopManager.submitOperationSignal: submitting operation signal of type '${aa}'`);this.x6.submitOperation(Object(f.a)(new W,
{operation:Object(f.a)(new ka.a,{parentPath:["Signal",Object.getTypeName(Z)],items:[Object(f.a)(new V.a,{body:Z})]})}))}else d.ULS.shipAssertTag(537170385,0,!1,"AugmentationLoopManager.submitOperationSignal: signal is null")}registerLocalWorkflow(Z){if(!Z)return d.ULS.shipAssertTag(537170383,0,!1,"AugmentationLoopManager.registerLocalWorkflow: workflow is null"),"InvalidParameterFailure";d.ULS.sendTraceTag(537170382,0,50,`AugmentationLoopManager.registerLocalWorkflow: registering local workflow '${Z.id}'`);
this.x6.registerLocalWorkflow(Object(f.a)(new K,{workflow:Z}));return"Success"}clk(Z,aa,Ea,za){Z=Object(f.a)(new ob,{heightPx:za,widthPx:Ea,contents:[Object(f.a)(new cb,{id:aa+".0",format:2,size:3,sizeBytes:Z.length,data:Z})]});aa=Object(f.a)(new V.a,{id:aa,body:Z});aa=Object(f.a)(new $a,{item:aa});d.ULS.sendTraceTag(520677600,0,50,"AugmentationLoopManager.uploadImage: submitting custom message");this.x6.submitCustomMessage(Object(f.a)(new S,{message:aa})).catch(bb=>{d.ULS.sendTraceTag(526406241,
0,50,`AugmentationLoopManager.uploadImage: submitCustomMessage promise rejected with error ${bb}`);return"UnknownFailure"})}dispose(){this.$&&this.$.da&&this.$.da.Vl(this.Qe);this.$&&this.$.Gd&&(this.$.Gd.hj(this.Vf),this.$.va.hj(this.Vf));this.$&&this.$.pa&&this.$.pa.Uu(this.wYb);this.hJc();super.dispose()}vng(){this.kh||(this.kh=this.$.da.kh,this.kh.qwa(this.jDa));this.$.da.YE(this.WD)}hJc(){this.kh&&(this.kh.jEa(this.jDa),this.kh=null);this.$.da.kG(this.WD)}udh(Z,aa){for(const Ea of this.Y$.values())if(this.uS===
Jb.FullyActive||!Ea.annotations.every(za=>za.Yt))try{Ea.tM(Z,aa)}catch(za){d.ULS.sendTraceTag(509674971,0,10,`AugmentationLoopManager.callAugloopCloseCallbacks: caught exception from ${Ea.featureName} close callback with message: ${za.message}`)}}Oxi(){this.wqa=new gb.a;this.wqa.ga(O.a.getTypeName(),1);this.wqa.ga(Da.a.getTypeName(),2);this.wqa.ga(U.getTypeName(),5);this.wqa.ga(N.getTypeName(),3);this.wqa.ga(qa.getTypeName(),7);this.wqa.ga(R.getTypeName(),6);this.wqa.ga(ja.getTypeName(),4)}Ymi(Z,
aa){y.EwaSettings.isChangeGateEnabled("OfficeVSO:7746271_IntroduceDeleteAnnotationEvent")&&1!==aa&&d.ULS.sendTraceTag(508904538,0,15,`AugmentationLoopManager.handleAddOrUpdateOperation: handling operation of type ${aa}`);let Ea=!0;for(const bb of Z.items){if(!bb){d.ULS.sendTraceTag(537170376,0,10,"AugmentationLoopManager.handleAddOrUpdateOperation: Error in item");continue}if(y.EwaSettings.isChangeGateEnabled("OfficeVSO:7746271_IntroduceDeleteAnnotationEvent")){if(!bb.body||!this.Nrf(bb.body)){d.ULS.sendTraceTag(537170375,
0,10,"AugmentationLoopManager.handleAddOrUpdateOperation: Body is either null or not an annotation.");continue}}else if(!(Ba.a.WF(Z,[N.getTypeName()])||bb.body&&this.Nrf(bb.body))){d.ULS.sendTraceTag(508904537,0,10,"AugmentationLoopManager.handleAddOrUpdateOperation: Body is either null or not an annotation.");continue}var za=bb.source;if(this.Eub.includes(za)){d.ULS.sendTraceTag(520677597,0,100,`AugmentationLoopManager.handleAddOrUpdateOperation: Filtered out annotation of owner ${za}`);continue}za=
Ba.a.y8(bb.body);if(!za){d.ULS.sendTraceTag(523329624,0,50,"AugmentationLoopManager.handleAddOrUpdateOperation: annotationType is null");continue}const Mb=bb.body;if(!Mb){d.ULS.sendTraceTag(523329623,0,50,"AugmentationLoopManager.handleAddOrUpdateOperation: annotation is null");continue}this.CVd||(Ea=this.XYj(Mb)&&Ea);d.ULS.sendTraceTag(576271178,0,50,this.CVd?`AugmentationLoopManager.handleAddOrUpdateOperation: Triggering Event handler for Annotation ${za}. ParentRevId: ${Z.parentRevId}`:`AugmentationLoopManager.handleAddOrUpdateOperation: Triggering Event handler for Annotation ${za}. Should report: ${Ea}. ParentRevId: ${Z.parentRevId}`);
const zb=new m(Mb,null,Z.parentPath,aa);this.VFb?(this.x8b.oaf(Mb.id)&&d.ULS.sendTraceTag(508678295,0,50,`AugmentationLoopManager.handleAddOrUpdateOperation: received annotation whose Id is already in the pool, annotationType: ${za}, id: ${Mb.id}, operationType: ${aa}`),this.x8b.NMb(za,zb),this.raiseEvent(this.Uuc(za),zb,this),d.ULS.sendTraceTag(508678338,0,100,`AugmentationLoopManager.handleAddOrUpdateOperation: raising newAnnotation event (annotation type: ${za})`)):(this.WKa.WHi(zb.annotation.id,
Z.parentRevId)&&(this.raiseEvent(this.Uuc(za),zb,this),d.ULS.sendTraceTag(520677596,0,100,`AugmentationLoopManager.handleAddOrUpdateOperation: raising newAnnotation event (annotation type: ${za})`)),this.WKa.NMb(za,zb,Z.parentRevId))}!this.CVd&&this.ptc&&Ea&&(Z=z.a(this.oj,this.ptc.Zae),d.ULS.sendTraceTag(590906632,0,50,`AugmentationLoopManager.handleAddOrUpdateOperation: Got valid annotation, time elapse from last state id(${this.ptc.stateId}): ${Z}`))}Nrf(Z){return Ba.a.y8(Z)===G.a.getTypeName()||
0<=Array.indexOf(Ba.a.rCb(Z),G.a.getTypeName())}Bni(Z){for(const aa of Z.items)if(!aa)d.ULS.sendTraceTag(508913550,0,10,"AugmentationLoopManager.handleDeleteOperation: Error in item");else if(!aa.id)d.ULS.sendTraceTag(508913549,0,10,"AugmentationLoopManager.handleDeleteOperation: Item had no id");else if(this.VFb){const Ea=this.x8b.oaf(aa.id);if(Ea){Z.parentPath!==Ea.H6c.parentPath&&d.ULS.sendTraceTag(508875280,0,50,`AugmentationLoopManager.handleDeleteOperation: parentPath of the operation [${Z.parentPath}] is different from the parentPath of the stored annotation [${Ea.H6c.parentPath}]`);
d.ULS.sendTraceTag(508913548,0,100,`AugmentationLoopManager.handleDeleteOperation: raising deleteAnnotation event (annotation type: ${Ea.annotationType})`);const za=new m(Ea.H6c.annotation,Ea.H6c.parentObject,Z.parentPath,3);this.raiseEvent(this.tId(Ea.annotationType),za,this);this.x8b.d4i(aa.id)}}}XYj(Z){if(Z){if(y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.AutoCLPV2Transition",!1)){var aa=!!Z.recommended&&!!Z.recommended.id;return!!Z.automatic&&!!Z.automatic.id||aa}aa=!!Z.recommended&&
!!Z.recommended.sensitivityLabel&&!!Z.recommended.sensitivityLabel.id;return!!Z.automatic&&!!Z.automatic.sensitivityLabel&&!!Z.automatic.sensitivityLabel.id||aa}return!1}Hxj(){this.register(this.YX().TZ("ALManagerInternalAnnotations").RZ(()=>{}).activateAnnotation({annotationType:Ka.getTypeName(),Yt:!1,AN:this.b3i,isInternal:!0}).build());y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1)&&this.X$("ALManagerInternalAnnotations",{annotationType:"AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation",
Yt:!0});y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TablelintComparison",!1)&&this.X$("ALManagerInternalAnnotations",{annotationType:"AugLoop_Excel_ExcelComparisonAnnotation",Yt:!0})}Eib(Z,aa){aa=void 0===aa?"":aa;y.EwaSettings.isChangeGateEnabled("OfficeVSO:7578618_ObserverRequiredNotificationsToECSOnlyInEditMode")?this.$.isEditMode&&this.$.da.sessionId&&(d.ULS.sendTraceTag(509371223,0,50,`AugmentationLoopManager.sendObserverRequiredNotification: isObserverRequired: ${this.isObserverRequired}, caller: ${aa}`),
k(this.$.pa.ua,Z,null,null,null,null)):k(this.$.pa.ua,Z,null,null,null,null)}Ihj(Z,aa){if(this.XNc.DocId!==Z.DocId||this.XNc.Xluid!==Z.Xluid&&this.XNc.Xrevid!==Z.Xrevid)this.XNc=Z,this.raiseEvent("CoauthVersionChanged",{coauthVersion:Z,userContext:aa},this),this.VFb||this.WKa.Hhj(Z)}};ub=Object(r.a)([Object(Sa.d)(ib.i),Object(r.b)(0,Object(ib.R)()),Object(r.b)(1,Object(ib.h)())],ub);Object(e.a)(ub,"AugmentationLoopManager",u.a,[629,5]);var Qa=a(40);class P extends D.a{constructor(Z){super();this.augmentationLoopManager=
null;this.$=Z;this.Md();d.ULS.sendTraceTag(520939607,0,50,"AugmentationLoopManagerFactory.constructor: called")}create(){const Z=Date.now();h.Health.instance.recordKpiUsageForAlertableKpi("AugmentationLoopManagerCreation","xlalint",null);d.ULS.sendTraceTag(537170371,0,50,"AugmentationLoopManagerFactory.create: called");let aa=null;const Ea=[];aa=Object(Wb.d)(Sa.a.resolve(ib.Nb,{Qa:this.Na}));Ea.push(aa);Qa.TaskExtensions.ya(Qa.TaskExtensions.Bf(Ea,this.ka,3),()=>{(y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.MigrateAugmentationLoopToNewServiceInfra",
!1)?Sa.a.resolve(ib.h,{Qa:this.Na}):Gc.fGd(this.$,aa?aa.result:null,this.Na)).then(za=>{d.ULS.sendTraceTag(537170370,0,50,"AugmentationLoopManagerFactory.create: Augmentation Loop runtime initialized");try{this.qd(this.augmentationLoopManager||(this.augmentationLoopManager=new ub(this.$,za,new Pb(this.$.xa.AugmentationLoopAnnotationExpirationTimeoutInMs)))),Gc.pfg(this.augmentationLoopManager.WMb)}catch(bb){h.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation","Exception",!1,!0,Object(f.a)(new Ob.a,
{extendedProperties:new Map,durationMs:Date.now()-Z})),this.qd(null),d.ULS.sendTraceTag(42796228,0,10,`AugmentationLoopManagerFactory.create: Augmentation loop initialization failed. Exception ${bb.message}`)}}).catch(()=>{h.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation","PromiseRejected",!1,!0,Object(f.a)(new Ob.a,{extendedProperties:new Map,durationMs:Date.now()-Z}));this.qd(null);d.ULS.sendTraceTag(42796229,0,10,"AugmentationLoopManagerFactory.create: Augmentation loop initialization failed")})},
this.$.ka,3)}static la(Z){d.ULS.sendTraceTag(520939606,0,50,"AugmentationLoopManagerFactory.attach: called");Z.ea.Ja(327,new P(Z))}}Object(e.a)(P,"AugmentationLoopManagerFactory",D.a,[]);var ta=a(10);String(w);window.___1688279118687_closurehack=w;(()=>{ta.a.Fa(Z=>{y.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.MigrateAugmentationLoopToNewServiceInfra",!1)||P.la(Z)})})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaTS.augmentationloop.js.map/50d60263aaa8f053f87e131cc0c8fa77/EwaTS.augmentationloop.js.map